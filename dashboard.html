<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Honest News – Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<style>
  body{margin:0;font-family:system-ui,sans-serif;background:#f4f6f9;color:#1e293b;height:100vh;display:flex;flex-direction:column}
  .header{background:#1e293b;color:#fff;padding:20px;display:flex;justify-content:space-between;align-items:center}
  .header h1{font-size:1.4rem;margin:0}
  .header a{color:#94a3b8;text-decoration:none}
  .main{flex:1;display:flex;overflow:hidden}
  .sidebar{width:300px;background:#fff;border-right:1px solid #e2e8f0;padding:20px;overflow-y:auto}
  .page{padding:15px;margin:10px 0;background:#f8fafc;border-radius:10px;cursor:pointer;font-weight:600}
  .page.active{background:#4338ca;color:#fff}
  .content{flex:1;padding:40px;overflow-y:auto}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:30px;margin-bottom:30px;box-shadow:0 4px 20px rgba(0,0,0,0.05)}
  input,textarea,select{width:100%;padding:14px;margin:10px 0;border-radius:10px;border:1px solid #cbd5e1;font-size:16px}
  button{background:#28a745;color:#fff;border:none;padding:14px 28px;border-radius:10px;cursor:pointer;font-weight:600}
  button:hover{background:#218838}
  .block{margin:20px 0;padding:20px;background:#f8fafc;border:2px dashed #cbd5e1;border-radius:12px;position:relative}
  .block:hover{border-color:#28a745}
  .tools{position:absolute;top:8px;right:8px;opacity:0;transition:0.2s}
  .block:hover .tools{opacity:1}
  .tools button{background:none;border:none;cursor:pointer;font-size:18px;margin:0 4px;color:#6366f1}
  .preview{margin-top:40px;padding:40px;background:#fff;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,0.1)}
  label.inline{display:inline-flex;align-items:center;gap:.4rem;margin-right:1.2rem;font-size:.9rem}
</style>
</head>
<body>

<div class="header">
  <h1>Honest News – Site Editor</h1>
  <a href="/" target="_blank">View Live Site →</a>
</div>

<div class="main">
  <div class="sidebar">
    <h3>Pages</h3>
    <div id="pages"></div>
    <button onclick="newPage()" style="width:100%;margin-top:20px">+ New Page</button>

    <h3 style="margin-top:30px">Navigation (basic)</h3>
    <small>Menu items (one per line): Title | URL</small>
    <textarea id="menuRaw" rows="6" oninput="menuFromRaw(this.value)"></textarea>
  </div>

  <div class="content" id="editor">
    <div class="card">
      <h2>Select a page to start editing</h2>
    </div>
  </div>
</div>

<script>
// ---------------------------
// BASIC SITE DATA MODEL
// ---------------------------
let site = {
  menu: [
    { title:"Home", url:"index.html" },
    { title:"Podcast", url:"podcast.html" },
    { title:"Shop", url:"shop.html" },
    { title:"Support", url:"support.html" },
    { title:"Contact", url:"contact.html" }
  ],
  pages: [
    {
      title:"Home",
      slug:"home",
      theme:"dark",
      hero:{
        bg:"https://images.unsplash.com/photo-1506905925346-21bda4d32df4?auto=format&fit=crop&w=1920&q=80",
        overlay:"Honest News Network",
        sub:"Everything You Need for Biblical Truth",
        transparentMenu:false,
        behavior:"parallax-medium"
      },
      blocks:[]
    },
    {
      title:"Podcast",
      slug:"podcast",
      theme:"dark",
      hero:{
        bg:"",
        overlay:"Latest Episodes",
        sub:"New episodes every Sunday",
        transparentMenu:true,
        behavior:"parallax-slow"
      },
      blocks:[]
    },
    {
      title:"Shop",
      slug:"shop",
      theme:"dark",
      hero:{
        bg:"",
        overlay:"Recommended Resources",
        sub:"Support your walk and support the ministry",
        transparentMenu:true,
        behavior:"still"
      },
      blocks:[]
    }
  ]
};

let current = null;

// ---------------------------
// MENU EDIT HELPERS
// ---------------------------
function rawFromMenu(){
  const t = site.menu.map(m=>`${m.title} | ${m.url}`).join("\n");
  const ta = document.getElementById("menuRaw");
  if(ta) ta.value = t;
}
function menuFromRaw(text){
  const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  site.menu = lines.map(l=>{
    const [title,url] = l.split("|").map(s=>(s||"").trim());
    return {title,title: title||"Item",url:url||"#"};
  });
}

// ---------------------------
// PAGE LIST
// ---------------------------
function renderPages(){
  const pagesDiv = document.getElementById("pages");
  pagesDiv.innerHTML = site.pages.map((p,i)=>`
    <div class="page ${p===current?'active':''}" onclick="select(${i})">${p.title}</div>
  `).join("");
  if(!current && site.pages.length) select(0);
  rawFromMenu();
}

function select(i){
  current = site.pages[i];
  renderPages();
  const c = current;
  const transparentChecked = c.hero.transparentMenu ? "checked" : "";
  const themeLight = c.theme === "light" ? "checked" : "";
  const themeDark = !themeLight ? "checked" : "";
  const behavior = c.hero.behavior || "still";

  document.getElementById("editor").innerHTML = `
    <div class="card">
      <h2>Editing: ${c.title}</h2>

      <h3>Hero Settings</h3>
      <input value="${c.hero.bg||''}" placeholder="Hero image URL" onchange="current.hero.bg=this.value;preview()">
      <input value="${c.hero.overlay||''}" placeholder="Main title" onchange="current.hero.overlay=this.value;preview()">
      <input value="${c.hero.sub||''}" placeholder="Subtitle (optional)" onchange="current.hero.sub=this.value;preview()">

      <label class="inline">
        <input type="checkbox" ${transparentChecked}
          onchange="current.hero.transparentMenu=this.checked;preview()">
        Transparent menu on this page
      </label>

      <div style="margin-top:10px">
        <strong>Hero Behavior:</strong>
        <select onchange="current.hero.behavior=this.value;preview()">
          <option value="still" ${behavior==='still'?'selected':''}>Still Image</option>
          <option value="parallax-slow" ${behavior==='parallax-slow'?'selected':''}>Slow Parallax</option>
          <option value="parallax-medium" ${behavior==='parallax-medium'?'selected':''}>Medium Parallax</option>
          <option value="float-up" ${behavior==='float-up'?'selected':''}>Float Up</option>
        </select>
      </div>

      <div style="margin-top:16px">
        <strong>Page Theme:</strong><br>
        <label class="inline">
          <input type="radio" name="theme-${i}" value="light" ${themeLight?'checked':''}
            onchange="current.theme='light';preview()"> Light
        </label>
        <label class="inline">
          <input type="radio" name="theme-${i}" value="dark" ${themeDark?'checked':''}
            onchange="current.theme='dark';preview()"> Dark
        </label>
      </div>

      <h3 style="margin-top:40px">Content Blocks</h3>
      <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px">
        <button onclick="addBlock('heading')">+ Heading</button>
        <button onclick="addBlock('paragraph')">+ Paragraph</button>
        <button onclick="addBlock('image')">+ Image</button>
        <button onclick="addBlock('button')">+ Button</button>
        <button onclick="addBlock('product')">+ Product (Amazon)</button>
        <button onclick="addBlock('podcast')">+ Podcast Episode</button>
        <button onclick="addBlock('youtube')">+ YouTube Video</button>
      </div>

      <div id="blocks"></div>

      <div class="preview">
        <h3>Live Preview</h3>
        <div style="background:url(${c.hero.bg||'none'}) center/cover;height:320px;position:relative;border-radius:14px;overflow:hidden;">
          <div style="position:absolute;inset:0;background:rgba(0,0,0,${c.hero.transparentMenu?0.4:0.7})"></div>
          <div style="position:relative;color:#fff;text-align:center;padding-top:100px">
            <h1 style="font-size:2.4rem;margin:0">${c.hero.overlay||''}</h1>
            <p style="font-size:1.2rem;margin-top:.7rem">${c.hero.sub||''}</p>
          </div>
        </div>
        <div id="blockPreview" style="padding:30px"></div>
      </div>

      <div style="margin-top:30px">
        <button onclick="publish()" style="background:#16a34a;font-size:1.1rem;padding:16px 30px">PUBLISH (download site-data.json)</button>
        <button onclick="backupAll()" style="margin-left:10px;background:#0f172a">Download Full Backup (.zip)</button>
      </div>
    </div>
  `;
  renderBlocks(); preview();
}

// ---------------------------
// BLOCK EDITING
// ---------------------------
function addBlock(type){
  if(!current.blocks) current.blocks = [];
  const b = { type, motion:"fade" };
  if(type==="heading") b.content="New Heading";
  if(type==="paragraph") b.content="Your text here";
  if(type==="image") { b.mode="url"; b.content=""; }
  if(type==="button") { b.text="Click Me"; b.url="#"; }
  if(type==="product"){
    b.title="Product title";
    b.text="Short description of this resource.";
    b.image="";
    b.url="";
  }
  if(type==="podcast"){
    b.title="Episode title";
    b.embed="";
  }
  if(type==="youtube"){
    b.title="Video title";
    b.videoId="";
  }
  current.blocks.push(b);
  renderBlocks(); preview();
}

function move(i,d){
  const b=current.blocks.splice(i,1)[0];
  current.blocks.splice(i+d,0,b);
  renderBlocks(); preview();
}
function removeBlock(i){
  current.blocks.splice(i,1);
  renderBlocks(); preview();
}

function handleImageUpload(e,index){
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    current.blocks[index].content = reader.result;
    preview();
  };
  reader.readAsDataURL(file);
}

function renderBlocks(){
  const c = document.getElementById("blocks");
  if(!c) return;
  c.innerHTML = (current.blocks||[]).map((b,i)=>{
    const motion = b.motion || "fade";
    return `
    <div class="block">
      <div style="font-size:.8rem;color:#64748b;margin-bottom:6px">
        Type: ${b.type.toUpperCase()} &nbsp;
        <select onchange="current.blocks[${i}].motion=this.value;preview()" style="width:auto;padding:4px 8px;font-size:.8rem">
          <option value="none" ${motion==='none'?'selected':''}>No animation</option>
          <option value="fade" ${motion==='fade'?'selected':''}>Fade in</option>
          <option value="float" ${motion==='float'?'selected':''}>Float up</option>
          <option value="slide" ${motion==='slide'?'selected':''}>Slide up + fade</option>
        </select>
      </div>

      ${
        b.type==="heading"
        ? `<input value="${b.content||''}" onchange="current.blocks[${i}].content=this.value;preview()">`
        : ""
      }
      ${
        b.type==="paragraph"
        ? `<textarea rows="4" onchange="current.blocks[${i}].content=this.value;preview()">${b.content||''}</textarea>`
        : ""
      }
      ${
        b.type==="image"
        ? `
          <label>Image source:
            <select onchange="(current.blocks[${i}].mode=this.value);renderBlocks();preview()">
              <option value="url" ${b.mode!=="upload"?'selected':''}>URL</option>
              <option value="upload" ${b.mode==="upload"?'selected':''}>Upload</option>
            </select>
          </label>
          ${
            b.mode==="upload"
            ? `<input type="file" accept="image/*" onchange="handleImageUpload(event,${i})">`
            : `<input value="${b.content||''}" placeholder="Image URL" onchange="current.blocks[${i}].content=this.value;preview()">`
          }
        `
        : ""
      }
      ${
        b.type==="button"
        ? `
          Text:
          <input value="${b.text||''}" onchange="current.blocks[${i}].text=this.value;preview()">
          URL:
          <input value="${b.url||''}" onchange="current.blocks[${i}].url=this.value;preview()">
        `
        : ""
      }
      ${
        b.type==="product"
        ? `
          <input value="${b.title||''}" placeholder="Product title"
                 onchange="current.blocks[${i}].title=this.value;preview()">
          <textarea rows="3" placeholder="Short description"
                 onchange="current.blocks[${i}].text=this.value;preview()">${b.text||''}</textarea>
          <input value="${b.image||''}" placeholder="Image URL"
                 onchange="current.blocks[${i}].image=this.value;preview()">
          <input value="${b.url||''}" placeholder="Amazon affiliate URL"
                 onchange="current.blocks[${i}].url=this.value;preview()">
        `
        : ""
      }
      ${
        b.type==="podcast"
        ? `
          <input value="${b.title||''}" placeholder="Episode title"
                 onchange="current.blocks[${i}].title=this.value;preview()">
          <textarea rows="3" placeholder="Podbean embed URL or iframe src"
                 onchange="current.blocks[${i}].embed=this.value;preview()">${b.embed||''}</textarea>
        `
        : ""
      }
      ${
        b.type==="youtube"
        ? `
          <input value="${b.title||''}" placeholder="Video title"
                 onchange="current.blocks[${i}].title=this.value;preview()">
          <input value="${b.videoId||''}" placeholder="YouTube URL or ID"
                 onchange="current.blocks[${i}].videoId=this.value;preview()">
        `
        : ""
      }

      <div class="tools">
        <button onclick="move(${i},-1)" title="Move up">↑</button>
        <button onclick="move(${i},1)" title="Move down">↓</button>
        <button onclick="removeBlock(${i})" title="Remove">×</button>
      </div>
    </div>
    `;
  }).join("");
}

// ---------------------------
// PREVIEW RENDER
// ---------------------------
function escapeHtml(str){
  return String(str||"")
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;");
}

function preview(){
  const c = current;
  if(!c) return;
  let html = "";
  (c.blocks||[]).forEach(b=>{
    if(b.type==="heading"){
      html += `<h2>${escapeHtml(b.content)}</h2>`;
    } else if(b.type==="paragraph"){
      const text = (b.content||"").replace(/\n/g,"<br>");
      html += `<p>${text}</p>`;
    } else if(b.type==="image" && b.content){
      html += `<img src="${escapeHtml(b.content)}" style="max-width:100%;border-radius:12px;margin:1.5rem 0">`;
    } else if(b.type==="button"){
      html += `<a href="${escapeHtml(b.url||'#')}"
         style="background:#28a745;color:#fff;padding:0.9rem 2.4rem;border-radius:999px;display:inline-block;margin:0.75rem 0;text-decoration:none;font-weight:600">
         ${escapeHtml(b.text||'Learn more')}
      </a>`;
    } else if(b.type==="product"){
      html += `
      <div style="background:#111827;border-radius:14px;padding:1.5rem;margin:1rem 0;display:flex;gap:1.5rem;align-items:flex-start;color:#e5e7eb">
        ${b.image?`<img src="${escapeHtml(b.image)}" style="width:140px;max-width:40%;border-radius:10px;object-fit:cover">`:""}
        <div>
          <h3 style="margin:0 0 .4rem;font-size:1.1rem">${escapeHtml(b.title||'')}</h3>
          <p style="margin:0 0 .8rem;font-size:.92rem;color:#cbd5e1">${escapeHtml(b.text||'')}</p>
          ${b.url?`<a href="${escapeHtml(b.url)}" target="_blank" rel="noopener noreferrer"
             style="background:#22c55e;color:#020617;padding:0.6rem 1.6rem;border-radius:999px;text-decoration:none;font-weight:600;font-size:.9rem">
             Buy on Amazon
           </a>`:""}
        </div>
      </div>`;
    } else if(b.type==="podcast" && b.embed){
      html += `
      <div style="margin:2rem 0">
        <h3>${escapeHtml(b.title||'')}</h3>
        <iframe src="${escapeHtml(b.embed)}" style="width:100%;height:160px;border:none" allow="autoplay"></iframe>
      </div>`;
    } else if(b.type==="youtube" && b.videoId){
      let id = b.videoId.trim();
      const m = id.match(/v=([^&]+)/);
      if(m) id = m[1];
      html += `
      <div style="margin:2rem 0">
        <h3>${escapeHtml(b.title||'')}</h3>
        <div style="position:relative;padding-bottom:56.25%;height:0;overflow:hidden;border-radius:12px;">
          <iframe src="https://www.youtube.com/embed/${escapeHtml(id)}"
                  style="position:absolute;top:0;left:0;width:100%;height:100%;border:none"
                  allowfullscreen></iframe>
        </div>
      </div>`;
    }
  });
  const bp = document.getElementById("blockPreview");
  if(bp) bp.innerHTML = html;
}

// ---------------------------
// ADD / SAVE / BACKUP
// ---------------------------
function newPage(){
  const t = prompt("Page title?");
  if(!t) return;
  const slug = t.toLowerCase().replace(/\s+/g,"-");
  site.pages.push({
    title:t,
    slug,
    theme:"dark",
    hero:{bg:"",overlay:t,sub:"",transparentMenu:false,behavior:"still"},
    blocks:[]
  });
  renderPages();
}

function publish(){
  const blob = new Blob([JSON.stringify(site,null,2)],{type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "site-data.json";
  a.click();
  alert("Downloaded site-data.json – upload this to your repo root to update the live site.");
}

async function backupAll(){
  const zip = new JSZip();
  zip.file("site-data.json", JSON.stringify(site,null,2));

  const files = [
    "index.html",
    "podcast.html",
    "shop.html",
    "contact.html",
    "admin.html",
    "dashboard.html",
    "live.js"
  ];

  for(const f of files){
    try{
      const res = await fetch(f,{cache:"no-store"});
      if(res.ok){
        const text = await res.text();
        zip.file(f,text);
      }
    }catch(e){
      console.warn("Could not add to backup:", f, e);
    }
  }

  const blob = await zip.generateAsync({type:"blob"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "honest-news-full-backup.zip";
  a.click();
  alert("Full backup downloaded. Store this .zip somewhere safe.");
}

// ---------------------------
// INIT
// ---------------------------
renderPages();

</script>
</body>
</html>

